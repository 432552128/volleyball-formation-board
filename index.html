<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バレーボール フォーメーションボード</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF & 画像保存ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .aspect-court { aspect-ratio: 1 / 2; }
        
        #formation-view {
            display: flex;
            flex-direction: column;
            align-items: center; /* This centers the court */
        }
        #formation-view #court-container {
            height: 160mm;
            width: 80mm; /* Explicitly set width to maintain aspect ratio with fixed height */
        }

        .player-piece {
            width: 52px; height: 52px; border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-weight: bold; color: white;
            position: absolute; cursor: grab; user-select: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.8); touch-action: none; padding: 2px;
            text-align: center; line-height: 1.1; transition: box-shadow 0.2s, opacity 0.3s;
        }
        .player-piece .player-number { font-size: 1.0rem; min-height: 1.2rem; }
        .player-piece .player-name { font-size: 0.65rem; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-piece .player-position {
            font-size: 0.65rem; background-color: rgba(0,0,0,0.2); padding: 0 3px;
            border-radius: 4px; margin-top: 2px; min-height: 0.8rem;
            transition: background-color 0.2s, padding 0.2s;
        }
        .player-piece .player-position.empty { background-color: transparent; padding: 0; }
        .player-piece:active { cursor: grabbing; z-index: 1000; }
        
        .volleyball {
            width: 35px; height: 35px; border-radius: 50%; background: white;
            position: absolute; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            touch-action: none; z-index: 999; border: 2px solid #333; overflow: hidden;
            transition: opacity 0.3s;
        }
        .volleyball::before, .volleyball::after {
            content: ''; position: absolute; width: 150%; height: 60%;
            background: #0051a3; border-bottom: 2px solid #333;
            border-radius: 0 0 50% 50%; left: -25%; top: -20%; transform: rotate(-35deg);
        }
        .volleyball::after {
            background: #ffd700; border-bottom: none; border-top: 2px solid #333;
            border-radius: 50% 50% 0 0; top: auto; bottom: -20%;
        }
        .volleyball:active { cursor: grabbing; }

        .trash-can { transition: transform 0.2s, color 0.2s; }
        .trash-can.over { transform: scale(1.2); color: #ef4444; }

        .btn-add {
            color: white; font-weight: bold; padding-top: 0.5rem; padding-bottom: 0.5rem;
            border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-size: 0.75rem; transition: transform 0.2s;
        }
        .btn-add:hover { transform: scale(1.05); }

        .serving-order-cell {
            transition: background-color 0.2s;
        }
        .mode-btn.active {
             background-color: white; color: #374151; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto">
        <!-- 表示エリア -->
        <div id="capture-area" class="bg-gray-100 p-4 rounded-lg relative">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">バレーボール フォーメーションボード</h1>
            
            <div id="mode-switcher" class="flex justify-center mb-4 rounded-lg bg-gray-200 p-1">
                <button id="mode-formation-btn" class="mode-btn active flex-1 py-2 px-4 text-sm font-semibold rounded-md">フォーメーション</button>
                <button id="mode-serve-order-btn" class="mode-btn flex-1 py-2 px-4 text-sm font-semibold rounded-md text-gray-500">サーブ順</button>
            </div>

            <!-- サーブ順モード用ビュー -->
            <div id="serve-order-view" class="hidden">
                <div id="serve-order-list-container" class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="font-bold text-center text-sm mb-2 text-blue-600">味方チーム サーブ順</h3>
                        <div id="home-serving-order" class="space-y-1"></div>
                    </div>
                    <div id="opponent-serve-order-container">
                        <h3 class="font-bold text-center text-sm mb-2 text-red-600">相手チーム サーブ順</h3>
                        <div id="opponent-serving-order" class="space-y-1"></div>
                    </div>
                </div>
                <div id="half-court-wrapper" class="relative bg-blue-200 border-x-4 border-b-4 border-gray-900 rounded-b-lg shadow-xl" style="aspect-ratio: 2 / 2;">
                    <!-- court-containerがここに入る -->
                </div>
                 <div id="home-bench-container-serve" class="mt-4 w-full hidden">
                     <div id="home-bench-area-serve" class="p-2 border-2 border-dashed border-gray-400 rounded-lg min-h-[80px] relative">
                        <span class="absolute -top-3 left-2 bg-gray-100 px-2 text-sm font-bold text-gray-500">味方控え</span>
                    </div>
                </div>
            </div>
            
            <!-- フォーメーションモード用ビュー -->
            <div id="formation-view">
                 <div id="opponent-bench-container" class="mb-4 w-full hidden">
                    <div id="opponent-bench-area" class="p-2 border-2 border-dashed border-gray-400 rounded-lg min-h-[80px] relative">
                        <span class="absolute -top-3 left-2 bg-gray-100 px-2 text-sm font-bold text-gray-500">相手控え</span>
                    </div>
                </div>
                <div id="court-container" class="bg-blue-200 border-4 border-gray-900 rounded-lg shadow-xl aspect-court relative flex flex-col overflow-hidden"></div>
                 <div id="home-bench-container" class="mt-4 w-full hidden">
                     <div id="home-bench-area" class="p-2 border-2 border-dashed border-gray-400 rounded-lg min-h-[80px] relative">
                        <span class="absolute -top-3 left-2 bg-gray-100 px-2 text-sm font-bold text-gray-500">味方控え</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 操作ボタンエリア -->
        <div id="controls-container">
            <!-- フォーメーションモード用 -->
            <div id="formation-controls" class="p-4">
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button id="add-home-player" class="btn-add bg-blue-500 hover:bg-blue-600">味方選手</button>
                    <button id="add-home-libero" class="btn-add bg-green-500 hover:bg-green-600">味方リベロ</button>
                    <button id="add-opponent-player" class="btn-add bg-red-500 hover:bg-red-600">相手選手</button>
                    <button id="add-opponent-libero" class="btn-add bg-orange-500 hover:bg-orange-600">相手リベロ</button>
                    <button id="add-ball" class="col-span-4 btn-add bg-yellow-400 hover:bg-yellow-500 text-gray-800 text-sm">ボール追加</button>
                </div>
                <div class="flex justify-end space-x-2 mb-4">
                    <button id="toggle-benches" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full">控え選手 ON/OFF</button>
                </div>
                <div class="flex justify-center items-center h-16">
                    <svg id="trash-can-formation" class="trash-can h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </div>
            </div>

            <!-- サーブ順モード用 -->
            <div id="serve-order-controls" class="p-4 hidden">
                 <div class="flex justify-end space-x-2 mb-4">
                    <button id="toggle-home-bench-serve" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full">味方控え ON/OFF</button>
                    <button id="toggle-opponent-serve" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full">相手サーブ順 ON/OFF</button>
                </div>
                 <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="add-home-player-serve" class="btn-add bg-blue-500 hover:bg-blue-600">味方選手</button>
                    <button id="add-home-libero-serve" class="btn-add bg-green-500 hover:bg-green-600">味方リベロ</button>
                </div>
                <div class="flex justify-center items-center h-16">
                    <svg id="trash-can-serve" class="trash-can h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="player-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[2000]">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm shadow-xl">
            <h2 class="text-xl font-bold mb-4">選手情報</h2>
            <div><label for="player-number" class="block text-sm font-medium text-gray-700">背番号</label><input type="number" id="player-number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
            <div class="mt-4"><label for="player-name" class="block text-sm font-medium text-gray-700">名前</label><input type="text" id="player-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
            <div class="mt-4"><label for="player-position" class="block text-sm font-medium text-gray-700">ポジション</label><input type="text" id="player-position" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
            <div class="mt-6 flex justify-end space-x-3"><button id="cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">キャンセル</button><button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">保存</button></div>
        </div>
    </div>

    <div id="serve-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[2000]">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm shadow-xl">
            <h2 id="serve-order-modal-title" class="text-xl font-bold mb-4">サーブ順の選手</h2>
            <div>
                <label for="serve-order-input" class="block text-sm font-medium text-gray-700">背番号または名前</label>
                <input type="text" id="serve-order-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mt-6 flex justify-end space-x-3"><button id="serve-order-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">キャンセル</button><button id="serve-order-save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">保存</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const getEl = (id) => document.getElementById(id);

            const courtContainer = getEl('court-container');
            const trashCanFormation = getEl('trash-can-formation');
            const trashCanServe = getEl('trash-can-serve');
            const playerModal = getEl('player-modal');
            const saveButton = getEl('save-button');
            const cancelButton = getEl('cancel-button');
            const playerNumberInput = getEl('player-number');
            const playerNameInput = getEl('player-name');
            const playerPositionInput = getEl('player-position');
            const homeServingOrderContainer = getEl('home-serving-order');
            const opponentServingOrderContainer = getEl('opponent-serving-order');
            const opponentServeOrderContainer = getEl('opponent-serve-order-container');
            const serveOrderModal = getEl('serve-order-modal');
            const serveOrderModalTitle = getEl('serve-order-modal-title');
            const serveOrderInput = getEl('serve-order-input');
            const serveOrderSaveButton = getEl('serve-order-save-button');
            const serveOrderCancelButton = getEl('serve-order-cancel-button');
            const serveOrderListContainer = getEl('serve-order-list-container');
            const homeBenchContainer = getEl('home-bench-container');
            const opponentBenchContainer = getEl('opponent-bench-container');
            const homeBenchContainerServe = getEl('home-bench-container-serve');

            const modeFormationBtn = getEl('mode-formation-btn');
            const modeServeOrderBtn = getEl('mode-serve-order-btn');
            const formationView = getEl('formation-view');
            const serveOrderView = getEl('serve-order-view');
            const halfCourtWrapper = getEl('half-court-wrapper');
            const toggleOpponentServeBtn = getEl('toggle-opponent-serve');
            const toggleHomeBenchServeBtn = getEl('toggle-home-bench-serve');
            const toggleBenchesBtn = getEl('toggle-benches');
            const formationControls = getEl('formation-controls');
            const serveOrderControls = getEl('serve-order-controls');

            let state = {
                pieces: new Map(),
                nextPieceId: 0,
                activePiece: null,
                servingOrder: {
                    home: Array(6).fill(null),
                    opponent: Array(6).fill(null)
                },
                mode: 'formation'
            };
            
            let courtHTML; 

            function buildCourt() {
                courtContainer.innerHTML = `
                    <div class="opponent-half w-full h-1/2 border-b-2 border-gray-900 relative"><div class="absolute bottom-0 w-full h-1/3 border-t-2 border-gray-900"></div></div>
                    <div class="home-half w-full h-1/2 relative"><div class="absolute top-0 w-full h-1/3 border-b-2 border-gray-900"></div></div>
                    <div class="absolute top-1/2 left-0 w-full border-t-4 border-dashed border-gray-700 -translate-y-1/2"></div>
                    <div class="absolute top-1/2 left-[-12px] w-2 h-16 bg-red-500 border-2 border-white rounded-t-full -translate-y-full z-10"></div>
                    <div class="absolute top-1/2 left-[-12px] w-2 h-16 bg-white border-2 border-white rounded-b-full z-10"></div>
                    <div class="absolute top-1/2 right-[-12px] w-2 h-16 bg-red-500 border-2 border-white rounded-t-full -translate-y-full z-10"></div>
                    <div class="absolute top-1/2 right-[-12px] w-2 h-16 bg-white border-2 border-white rounded-b-full z-10"></div>
                `;
                courtHTML = courtContainer.innerHTML;
            }

            function updateViewForMode() {
                const isFormationMode = state.mode === 'formation';
                
                modeFormationBtn.classList.toggle('active', isFormationMode);
                modeFormationBtn.classList.toggle('text-gray-500', !isFormationMode);
                modeServeOrderBtn.classList.toggle('active', !isFormationMode);
                modeServeOrderBtn.classList.toggle('text-gray-500', isFormationMode);

                formationView.classList.toggle('hidden', !isFormationMode);
                serveOrderView.classList.toggle('hidden', isFormationMode);
                formationControls.classList.toggle('hidden', !isFormationMode);
                serveOrderControls.classList.toggle('hidden', isFormationMode);
                
                if (isFormationMode) {
                    formationView.insertBefore(courtContainer, homeBenchContainer);
                    courtContainer.classList.add('aspect-court', 'flex', 'flex-col');
                    courtContainer.classList.remove('aspect-square');
                    courtContainer.classList.add('bg-blue-200', 'border-4', 'border-gray-900', 'rounded-lg', 'shadow-xl');
                    courtContainer.innerHTML = courtHTML;
                    state.pieces.forEach(p => p.classList.remove('hidden'));
                } else {
                    halfCourtWrapper.appendChild(courtContainer);
                    courtContainer.classList.remove('aspect-court', 'flex', 'flex-col');
                    courtContainer.classList.add('aspect-square');
                    courtContainer.classList.remove('bg-blue-200', 'border-4', 'border-gray-900', 'rounded-lg', 'shadow-xl');
                    courtContainer.innerHTML = `
                        <div class="absolute top-0 left-0 w-full border-t-4 border-dashed border-gray-700"></div>
                        <div class="absolute top-1/3 left-0 w-full border-b-2 border-gray-900"></div>
                    `;
                    state.pieces.forEach(p => {
                        const isHomePlayer = p.classList.contains('player-piece') && p.dataset.team === 'home';
                        p.classList.toggle('hidden', !isHomePlayer);
                    });
                }
            }

            modeFormationBtn.addEventListener('click', () => { if (state.mode !== 'formation') { state.mode = 'formation'; updateViewForMode(); } });
            modeServeOrderBtn.addEventListener('click', () => { if (state.mode !== 'serveOrder') { state.mode = 'serveOrder'; updateViewForMode(); } });

            function renderServingOrder() {
                const createCell = (team, pos, value) => `<div class="flex items-center text-xs"><div class="w-6 h-6 flex items-center justify-center font-bold text-gray-500">${pos + 1}</div><div data-team="${team}" data-pos="${pos}" class="serving-order-cell w-full h-6 flex items-center justify-center rounded bg-gray-200 text-gray-700 font-bold cursor-pointer">${value || ''}</div></div>`;
                homeServingOrderContainer.innerHTML = state.servingOrder.home.map((val, i) => createCell('home', i, val)).join('');
                opponentServingOrderContainer.innerHTML = state.servingOrder.opponent.map((val, i) => createCell('opponent', i, val)).join('');
                document.querySelectorAll('.serving-order-cell').forEach(cell => cell.addEventListener('click', handleServeOrderClick));
            }

            function handleServeOrderClick(e) {
                const cell = e.currentTarget;
                const team = cell.dataset.team;
                const pos = parseInt(cell.dataset.pos, 10);
                serveOrderModal.dataset.team = team;
                serveOrderModal.dataset.pos = pos;
                serveOrderModalTitle.textContent = `${team === 'home' ? '味方' : '相手'}チーム ${pos + 1}番`;
                serveOrderInput.value = state.servingOrder[team][pos] || '';
                serveOrderModal.classList.remove('hidden');
                serveOrderInput.focus();
            }

            function createPiece(type, team, isLibero) {
                const piece = document.createElement('div');
                const id = state.nextPieceId++;
                piece.dataset.id = id;
                piece.dataset.team = team;
                state.pieces.set(id, piece);

                if (type === 'player') {
                    piece.classList.add('player-piece');
                    piece.innerHTML = `<span class="player-number">&nbsp;</span><span class="player-name">Player</span><span class="player-position empty">&nbsp;</span>`;
                    if (team === 'home') piece.classList.add(isLibero ? 'bg-green-500' : 'bg-blue-500');
                    else piece.classList.add(isLibero ? 'bg-orange-500' : 'bg-red-500');
                } else { piece.classList.add('volleyball'); }
                
                const container = state.mode === 'serveOrder' ? halfCourtWrapper : courtContainer;
                const containerRect = container.getBoundingClientRect();
                const scrollX = window.scrollX, scrollY = window.scrollY;
                let topPercent;
                if (type === 'player') {
                    if(state.mode === 'serveOrder') topPercent = 0.5;
                    else topPercent = team === 'home' ? 0.6 : 0.2;
                } else topPercent = 0.48;

                const initialTop = containerRect.top + scrollY + containerRect.height * topPercent;
                const initialLeft = containerRect.left + scrollX + containerRect.width * 0.45;
                
                piece.style.position = 'absolute';
                piece.style.top = `${initialTop}px`;
                piece.style.left = `${initialLeft}px`;
                document.body.appendChild(piece);
                makeDraggable(piece);

                if (type === 'player') {
                    piece.addEventListener('click', () => {
                        if (piece.isBeingDragged) return;
                        state.activePiece = piece;
                        playerNumberInput.value = piece.dataset.number || '';
                        playerNameInput.value = piece.dataset.name || '';
                        playerPositionInput.value = piece.dataset.position || '';
                        playerModal.classList.remove('hidden');
                    });
                }
            }

            function makeDraggable(element) {
                let isDragging = false, offsetX, offsetY;
                const id = parseInt(element.dataset.id, 10);

                const startDrag = (e) => {
                    isDragging = true; element.isBeingDragged = false;
                    const event = e.type.includes('touch') ? e.touches[0] : e;
                    offsetX = event.clientX - element.getBoundingClientRect().left;
                    offsetY = event.clientY - element.getBoundingClientRect().top;
                    element.style.cursor = 'grabbing'; element.style.zIndex = 1000;
                    e.stopPropagation();
                };

                const drag = (e) => {
                    if (!isDragging) return;
                    element.isBeingDragged = true; e.preventDefault();
                    const event = e.type.includes('touch') ? e.touches[0] : e;
                    element.style.left = `${event.pageX - offsetX}px`;
                    element.style.top = `${event.pageY - offsetY}px`;
                    const isOverFormation = isOverlapping(element, trashCanFormation);
                    const isOverServe = isOverlapping(element, trashCanServe);
                    trashCanFormation.classList.toggle('over', state.mode === 'formation' && isOverFormation);
                    trashCanServe.classList.toggle('over', state.mode === 'serveOrder' && isOverServe);
                };

                const stopDrag = () => {
                    if (!isDragging) return;
                    isDragging = false; 
                    trashCanFormation.classList.remove('over');
                    trashCanServe.classList.remove('over');
                    element.style.cursor = 'grab';
                    element.style.zIndex = element.classList.contains('volleyball') ? '999' : '';
                    setTimeout(() => { element.isBeingDragged = false; }, 50);

                    const shouldDelete = (state.mode === 'formation' && isOverlapping(element, trashCanFormation)) || 
                                       (state.mode === 'serveOrder' && isOverlapping(element, trashCanServe));

                    if (shouldDelete) {
                        const { team, number, name } = element.dataset;
                        if(team && (number || name)) {
                            const order = state.servingOrder[team];
                            const valueToFind = number || name;
                            const index = order.indexOf(valueToFind);
                            if(index > -1) { order[index] = null; renderServingOrder(); }
                        }
                        element.remove(); state.pieces.delete(id);
                    }
                };
                
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: true });
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);
            }

            getEl('add-home-player').addEventListener('click', () => createPiece('player', 'home', false));
            getEl('add-home-libero').addEventListener('click', () => createPiece('player', 'home', true));
            getEl('add-opponent-player').addEventListener('click', () => createPiece('player', 'opponent', false));
            getEl('add-opponent-libero').addEventListener('click', () => createPiece('player', 'opponent', true));
            getEl('add-ball').addEventListener('click', () => createPiece('ball'));

            getEl('add-home-player-serve').addEventListener('click', () => createPiece('player', 'home', false));
            getEl('add-home-libero-serve').addEventListener('click', () => createPiece('player', 'home', true));
            
            toggleOpponentServeBtn.addEventListener('click', () => {
                opponentServeOrderContainer.classList.toggle('hidden');
                const isOpponentHidden = opponentServeOrderContainer.classList.contains('hidden');
                serveOrderListContainer.className = isOpponentHidden 
                    ? 'flex justify-center gap-4 mb-4' 
                    : 'grid grid-cols-2 gap-4 mb-4';
            });

            toggleHomeBenchServeBtn.addEventListener('click', () => {
                homeBenchContainerServe.classList.toggle('hidden');
            });

            toggleBenchesBtn.addEventListener('click', () => {
                homeBenchContainer.classList.toggle('hidden');
                opponentBenchContainer.classList.toggle('hidden');
            });

            saveButton.addEventListener('click', () => {
                if (!state.activePiece) return;
                const { team, number: oldNumber, name: oldName } = state.activePiece.dataset;
                const newNumberStr = playerNumberInput.value.trim();
                const newName = playerNameInput.value.trim() || 'No Name';
                const newNumber = newNumberStr === '' ? null : newNumberStr;

                if (team) {
                    const order = state.servingOrder[team];
                    const oldIdentifier = oldNumber || oldName;
                    const index = order.indexOf(oldIdentifier);
                    if (index > -1) { order[index] = newNumber || newName; renderServingOrder(); }
                }

                state.activePiece.dataset.number = newNumber;
                state.activePiece.dataset.name = newName;
                state.activePiece.dataset.position = playerPositionInput.value;
                state.activePiece.querySelector('.player-number').innerHTML = newNumber || '&nbsp;';
                state.activePiece.querySelector('.player-name').textContent = newName;
                const posEl = state.activePiece.querySelector('.player-position');
                posEl.innerHTML = playerPositionInput.value || '&nbsp;';
                posEl.classList.toggle('empty', !playerPositionInput.value);
                playerModal.classList.add('hidden');
                state.activePiece = null;
            });
            cancelButton.addEventListener('click', () => playerModal.classList.add('hidden'));
            
            serveOrderSaveButton.addEventListener('click', () => {
                const { team, pos } = serveOrderModal.dataset;
                const newValue = serveOrderInput.value.trim();
                if (team && pos) {
                    state.servingOrder[team][parseInt(pos, 10)] = newValue === '' ? null : newValue;
                    renderServingOrder();
                }
                serveOrderModal.classList.add('hidden');
            });
            serveOrderCancelButton.addEventListener('click', () => serveOrderModal.classList.add('hidden'));
            
            const isOverlapping = (e1, e2) => {
                const r1 = e1.getBoundingClientRect(), r2 = e2.getBoundingClientRect();
                return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
            };

            buildCourt();
            renderServingOrder();
            updateViewForMode();
        });
    </script>
</body>
</html>
